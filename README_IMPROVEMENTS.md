# 英语学习助手 - 上下文记忆改进

## 问题描述
原始版本的AI对上下文记忆不好，例如用户输入"task"后AI会生成文章，但继续询问文章内容时AI需要用户重新提供文章。

## 解决方案
添加了会话记忆功能，让AI能够记住之前的对话内容和生成的文章。

## 主要改进

### 1. 数据库改进 (db.py)
- 新增 `chat_history` 表存储对话历史
- 添加会话管理功能：
  - `save_chat_history()` - 保存聊天记录
  - `get_chat_history()` - 获取历史对话
  - `get_latest_task_content()` - 获取最新任务内容
  - `clear_old_chat_history()` - 清理旧记录

### 2. 应用逻辑改进 (app.py)
- 添加会话ID管理
- 实现上下文构建功能：
  - 自动包含最近的对话历史
  - 引用最新生成的英语阅读材料
  - 构建包含上下文的智能提示词
- 新增清除历史记录API

### 3. 前端改进 (templates/index.html)
- 添加"Clear History"按钮
- 实现历史记录清除功能
- 用户友好的确认对话框

## 功能特点

### 智能上下文记忆
- AI现在能记住最近5条对话
- 自动引用最新生成的英语文章内容
- 基于历史上下文提供更准确的回答

### 会话管理
- 每个用户会话有唯一ID
- 自动清理7天前的旧记录
- 支持手动清除当前会话历史

### 改进的用户体验
- 用户询问文章内容时，AI能直接引用之前生成的文章
- 连续对话更加自然流畅
- 支持基于上下文的深入讨论

## 使用示例

1. **生成文章**：
   ```
   用户: task
   AI: [生成英语阅读文章并保存]
   ```

2. **询问文章内容**：
   ```
   用户: 这篇文章的主要观点是什么？
   AI: [基于之前生成的文章内容回答]
   ```

3. **继续讨论**：
   ```
   用户: 文章中提到的经济理论有哪些？
   AI: [结合文章内容和对话历史回答]
   ```

## 技术实现

### 数据库结构
```sql
CREATE TABLE chat_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT,
    user_message TEXT,
    ai_response TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    message_type TEXT DEFAULT 'chat'
);
```

### 上下文构建算法
1. 获取最近5条对话记录
2. 提取最新的任务内容（如果存在）
3. 构建包含历史信息的提示词
4. 发送给AI模型处理

## 部署说明
1. 确保所有依赖已安装
2. 运行 `run_web.bat` 启动应用
3. 数据库表会自动创建和更新
4. 旧的聊天记录会自动清理（保留7天）

这些改进显著提升了AI助手的实用性和用户体验，解决了上下文记忆问题。